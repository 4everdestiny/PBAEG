"""
author : 4everdestiny
create_time : 2022.4.6
description : this is the code to check the payload in state

input : state and payload
output : True when success, False when failed
"""

import angr
from log.log import Log

log = Log()


class ExploitCheckState:
    def __init__(self, state=None, functionname="read", payloadlist=None):
        self.state = state
        self.functionname = functionname
        self.payloadlist = payloadlist

    def CheckPayload(self):
        if self.functionname == "read":
            self.ReadFunctionConstraint()

    def ReadFunctionConstraint(self):
        if self.functionname != "read":
            log.Exception("function name not read, error")
            return False
        state = self.state
        if self.functionname == "read":
            copystate = state.copy()
            rsi = copystate.solver.eval(copystate.regs.rsi)
            payload = self.payloadlist.GetContent()
            constrained_parameter_address = rsi
            constrained_parameter_size_bytes = len(payload)
            constrained_parameter_bitvector = state.memory.load(
                constrained_parameter_address,
                constrained_parameter_size_bytes
            )
            constrained_parameter_desired_value = payload
            constraint_expression = constrained_parameter_bitvector == constrained_parameter_desired_value
            copystate.add_constraints(constraint_expression)
            if copystate.satisfiable():
                log.info("have add constraint to rsi, read constraint finished")


